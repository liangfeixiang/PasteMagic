<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨è§£å¯†å·¥å…·åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        .card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1f2937;
        }
        textarea, input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 12px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2563eb;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .result-item {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .config-name {
            font-weight: 600;
            color: #1f2937;
        }
        .success-badge {
            background-color: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .fail-badge {
            background-color: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .plaintext {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .error {
            color: #ef4444;
            font-size: 14px;
        }
        .loading {
            color: #6b7280;
            font-style: italic;
        }
        .stats {
            background-color: #f3f4f6;
            padding: 16px;
            border-radius: 6px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” è‡ªåŠ¨è§£å¯†å·¥å…·åŠŸèƒ½æµ‹è¯•</h1>
            <p>æµ‹è¯•è‡ªåŠ¨è§£å¯†å·¥å…·çš„æ ¸å¿ƒåŠŸèƒ½</p>
        </div>

        <div class="card">
            <div class="card-title">ğŸ” æµ‹è¯•é…ç½®</div>
            <div>
                <label>é…ç½®åç§°:</label>
                <input type="text" id="configName" value="æµ‹è¯•AESé…ç½®" placeholder="é…ç½®åç§°">
            </div>
            <div>
                <label>ç®—æ³•:</label>
                <input type="text" id="algorithm" value="AES/CBC/PKCS5Padding" placeholder="ç®—æ³•">
            </div>
            <div>
                <label>å¯†é’¥ (Base64):</label>
                <input type="text" id="key" value="dGVzdGtleXRlc3RrZXl0ZXN0a2V5dGVzdGtleQ==" placeholder="å¯†é’¥">
            </div>
            <div>
                <label>IV (Base64):</label>
                <input type="text" id="iv" value="dGVzdGl2dGVzdGl2dGVzdGl2dGVzdGl2" placeholder="IV">
            </div>
            <button onclick="saveTestConfig()">ä¿å­˜æµ‹è¯•é…ç½®</button>
            <button onclick="loadConfigs()">åˆ·æ–°é…ç½®åˆ—è¡¨</button>
        </div>

        <div class="card">
            <div class="card-title">ğŸ”“ è‡ªåŠ¨è§£å¯†æµ‹è¯•</div>
            <div>
                <label>å¾…è§£å¯†å†…å®¹:</label>
                <textarea id="cipherText" placeholder="è¯·è¾“å…¥éœ€è¦è§£å¯†çš„å¯†æ–‡..."></textarea>
            </div>
            <button onclick="autoDecrypt()" id="decryptBtn">å¼€å§‹è‡ªåŠ¨è§£å¯†</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
            <div id="status"></div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“‹ é…ç½®åˆ—è¡¨</div>
            <div id="configList"></div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ¯ è§£å¯†ç»“æœ</div>
            <div id="results"></div>
            <div id="stats" class="stats" style="display: none;"></div>
        </div>
    </div>

    <script>
        let configs = [];
        
        // æ¨¡æ‹Ÿ Chrome å­˜å‚¨ API
        const chrome = {
            storage: {
                local: {
                    get: function(keys, callback) {
                        const result = {};
                        if (Array.isArray(keys)) {
                            keys.forEach(key => {
                                result[key] = localStorage.getItem(key);
                            });
                        } else if (typeof keys === 'string') {
                            result[keys] = localStorage.getItem(keys);
                        } else {
                            // è·å–æ‰€æœ‰é”®å€¼å¯¹
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key.startsWith('cipher_config_')) {
                                    result[key] = localStorage.getItem(key);
                                }
                            }
                        }
                        setTimeout(() => callback(result), 10);
                    },
                    set: function(items, callback) {
                        Object.keys(items).forEach(key => {
                            localStorage.setItem(key, items[key]);
                        });
                        if (callback) setTimeout(callback, 10);
                    }
                }
            }
        };

        // ç®€åŒ–çš„åŠ å¯†è§£å¯†å‡½æ•°
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function utf8ToBytes(str) {
            return new TextEncoder().encode(str);
        }

        function bytesToUtf8(bytes) {
            return new TextDecoder().decode(bytes);
        }

        // ç®€å•çš„ AES è§£å¯†æ¨¡æ‹Ÿ
        async function decryptData(cipherText, config) {
            try {
                // è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿè§£å¯†è¿‡ç¨‹
                // å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨ Web Crypto API æˆ–å…¶ä»–åŠ å¯†åº“
                
                // ç®€å•çš„æµ‹è¯•ï¼šå¦‚æœå¯†æ–‡åŒ…å«ç‰¹å®šæ ‡è®°ï¼Œåˆ™è¿”å›è§£å¯†ç»“æœ
                if (cipherText.includes('[ENCRYPTED]')) {
                    return cipherText.replace('[ENCRYPTED]', '[DECRYPTED]');
                }
                
                // å¯¹äº Base64 ç¼–ç çš„å†…å®¹ï¼Œå°è¯•ç®€å•å¤„ç†
                if (cipherText.startsWith('eyJ') || cipherText.includes('test')) {
                    return 'è¿™æ˜¯è§£å¯†åçš„æ˜æ–‡å†…å®¹';
                }
                
                throw new Error('è§£å¯†å¤±è´¥');
            } catch (error) {
                throw error;
            }
        }

        function isValidConfig(config) {
            return config && config.name && config.algorithm && config.key && config.iv;
        }

        // ä¿å­˜æµ‹è¯•é…ç½®
        function saveTestConfig() {
            const config = {
                name: document.getElementById('configName').value,
                algorithm: document.getElementById('algorithm').value,
                key: {
                    value: document.getElementById('key').value,
                    encoding: 'base64'
                },
                iv: {
                    value: document.getElementById('iv').value,
                    encoding: 'base64'
                },
                plainEncoding: ['utf-8'],
                cipherEncoding: ['base64']
            };

            const key = `cipher_config_${Date.now()}`;
            const configData = JSON.stringify(config);
            
            chrome.storage.local.set({ [key]: configData }, () => {
                alert('æµ‹è¯•é…ç½®å·²ä¿å­˜ï¼');
                loadConfigs();
            });
        }

        // åŠ è½½æ‰€æœ‰é…ç½®
        function loadConfigs() {
            chrome.storage.local.get(null, (items) => {
                configs = [];
                Object.keys(items).forEach(key => {
                    if (key.startsWith('cipher_config_')) {
                        try {
                            const config = JSON.parse(items[key]);
                            configs.push(config);
                        } catch (e) {
                            console.error('è§£æé…ç½®å¤±è´¥:', e);
                        }
                    }
                });
                
                displayConfigs();
            });
        }

        // æ˜¾ç¤ºé…ç½®åˆ—è¡¨
        function displayConfigs() {
            const container = document.getElementById('configList');
            if (configs.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">æš‚æ— é…ç½®</p>';
                return;
            }
            
            container.innerHTML = configs.map((config, index) => `
                <div style="padding: 8px; border-bottom: 1px solid #e5e5e5;">
                    <strong>${config.name}</strong> - ${config.algorithm}
                </div>
            `).join('');
        }

        // è‡ªåŠ¨è§£å¯†
        async function autoDecrypt() {
            const cipherText = document.getElementById('cipherText').value.trim();
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            const decryptBtn = document.getElementById('decryptBtn');
            
            if (!cipherText) {
                statusEl.innerHTML = '<div style="color: #ef4444;">è¯·è¾“å…¥å¾…è§£å¯†å†…å®¹</div>';
                return;
            }
            
            if (configs.length === 0) {
                statusEl.innerHTML = '<div style="color: #ef4444;">è¯·å…ˆæ·»åŠ æµ‹è¯•é…ç½®</div>';
                return;
            }
            
            decryptBtn.disabled = true;
            decryptBtn.textContent = 'è§£å¯†ä¸­...';
            statusEl.innerHTML = '<div class="loading">æ­£åœ¨å°è¯•è§£å¯†...</div>';
            resultsEl.innerHTML = '';
            
            const results = [];
            
            for (const config of configs) {
                try {
                    if (!isValidConfig(config)) {
                        results.push({
                            configName: config.name,
                            success: false,
                            error: 'é…ç½®æ— æ•ˆ',
                            plaintext: null
                        });
                        continue;
                    }
                    
                    const decrypted = await decryptData(cipherText, config);
                    
                    if (decrypted && decrypted !== cipherText) {
                        results.push({
                            configName: config.name,
                            success: true,
                            error: null,
                            plaintext: decrypted,
                            algorithm: config.algorithm
                        });
                    } else {
                        results.push({
                            configName: config.name,
                            success: false,
                            error: 'è§£å¯†å¤±è´¥æˆ–å†…å®¹æœªå‘ç”Ÿå˜åŒ–',
                            plaintext: null
                        });
                    }
                } catch (err) {
                    results.push({
                        configName: config.name,
                        success: false,
                        error: err.message || 'è§£å¯†è¿‡ç¨‹å‡ºé”™',
                        plaintext: null
                    });
                }
            }
            
            displayResults(results);
            decryptBtn.disabled = false;
            decryptBtn.textContent = 'å¼€å§‹è‡ªåŠ¨è§£å¯†';
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const resultsEl = document.getElementById('results');
            const statsEl = document.getElementById('stats');
            
            if (results.length === 0) {
                resultsEl.innerHTML = '<p style="color: #6b7280;">æš‚æ— è§£å¯†ç»“æœ</p>';
                statsEl.style.display = 'none';
                return;
            }
            
            const successfulCount = results.filter(r => r.success).length;
            
            resultsEl.innerHTML = results.map(result => `
                <div class="result-item">
                    <div class="result-header">
                        <span class="config-name">${result.configName}</span>
                        <span class="${result.success ? 'success-badge' : 'fail-badge'}">
                            ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}
                        </span>
                    </div>
                    ${result.success ? 
                        `<div class="plaintext">${result.plaintext}</div>` :
                        `<div class="error">é”™è¯¯: ${result.error}</div>`
                    }
                </div>
            `).join('');
            
            statsEl.innerHTML = `
                <strong>ç»Ÿè®¡ä¿¡æ¯:</strong> ${successfulCount}/${results.length} ä¸ªé…ç½®è§£å¯†æˆåŠŸ
            `;
            statsEl.style.display = 'block';
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('status').innerHTML = '';
            document.getElementById('cipherText').value = '';
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            loadConfigs();
        };
    </script>
</body>
</html>